<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Return to App — Reset Password</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;padding:24px;background:#f7fafc;color:#111}
    .card{max-width:640px;margin:48px auto;padding:24px;background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(16,24,40,.08)}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:8px 0 16px;color:#444}
    .btn{display:inline-block;padding:12px 18px;border-radius:8px;background:#2563eb;color:#fff;text-decoration:none}
    .muted{color:#666;font-size:14px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Reset your password</h1>
    <p class="muted">To finish resetting your password, please return to the app. You will be prompted to enter a new password there.</p>
    <p id="status">Opening the app…</p>
    <p>
      <a id="openBtn" class="btn" href="#">Open app</a>
      <a id="fallbackBtn" class="btn" style="background:#10b981;margin-left:8px" href="#">Open in browser (fallback)</a>
    </p>
    <p class="muted">If nothing happens, copy and paste this link into your device's browser or email client, or open the app manually.</p>
    <pre id="fullUrl" style="word-break:break-all;background:#f3f4f6;padding:12px;border-radius:8px"></pre>
  </div>

  <script>
    (function(){
      // Use the incoming URL (the Supabase ConfirmationURL). We will try to open the app with the same search/hash
      const incoming = window.location.href;
      // Construct deep link targets
      const supabaseScheme = 'io.supabase.flutterquickstart://login-callback';
      const customScheme = 'devcode://password-reset';
      const search = window.location.search || '';
      const hash = window.location.hash || '';

      // Prefer supabase scheme to preserve query parameters (token/type)
      const deepLinkSupabase = supabaseScheme + search + hash;
      const deepLinkCustom = customScheme + search + hash;

      const statusEl = document.getElementById('status');
      const fullUrlEl = document.getElementById('fullUrl');
      const openBtn = document.getElementById('openBtn');
      const fallbackBtn = document.getElementById('fallbackBtn');

      fullUrlEl.textContent = deepLinkSupabase;

      function tryOpen(target){
        // Attempt to open the app via location.href (works on iOS/Android native browsers) and via intent for Android
        const now = Date.now();
        // On some Android browsers intent: URL works better
        const intentUrl = 'intent://' + target.replace(/^[^:\/]+:\/\//, '') + '#Intent;scheme=' + target.split(':')[0] + ';package=' + (window.SUPABASE_APP_PACKAGE || '');
        // First try by changing location
        try {
          window.location.href = target;
        } catch(e) {}
        // If after 1 second we are still on the page, try intent (Android) as fallback
        setTimeout(function(){
          // For Android Chrome, try intent: fallback
          try {
            window.location.href = intentUrl;
          } catch(e){}
        }, 800);
      }

      // Auto-try open via supabase link first
      tryOpen(deepLinkSupabase);

      openBtn.addEventListener('click', function(e){
        e.preventDefault();
        tryOpen(deepLinkSupabase);
      });

      fallbackBtn.addEventListener('click', function(e){
        e.preventDefault();
        // Show the raw incoming URL so user can copy (browser fallback)
        fullUrlEl.textContent = incoming;
      });

      // Also show a friendly message and a small timer
      let dots = 0;
      const t = setInterval(()=>{
        dots = (dots+1)%4;
        statusEl.textContent = 'Opening the app' + '.'.repeat(dots);
      },300);
      // Stop after 6s
      setTimeout(()=>{
        clearInterval(t);
        statusEl.textContent = 'If the app didn\'t open, press `Open app` or copy the link below and open it from your device.';
      },6000);
    })();
  </script>
</body>
</html>
